---
title: Self-organizing settlement systems in variable environments
author:
  - name: Nicolas Gauthier
    email: Nicolas.Gauthier@asu.edu
    affiliation: Arizona State University
    footnote: Corresponding Author
address:
  - code: Arizona State University
    address: School of Human Evolution and Social Change, S. Caddy Mall, Tempe, AZ, Zip
abstract:

journal: "Journal of Archaeological Science"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
output:
 bookdown::pdf_book:
  base_format: rticles::elsevier_article
---


```{r echo = FALSE, eval = FALSE, cache=TRUE}
# Install necessary packages if not already available (not run by default)
install.packages(c('tidyverse', 'tidygraph', 'furrr'))
#bookdown and rticles too?
# install the dev versions of these packages from github using devtools
install.packages('devtools')
devtools::install_github('tidyverse/tidyr')
devtools::install_github('thomasp85/ggraph')
devtools::install_github('thomasp85/patchwork')
```

```{r setup, include=FALSE, mesage = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = TRUE)

library(tidyverse)
library(tidygraph)
library(ggraph)
library(sf)
library(gganimate)
library(patchwork)
library(furrr)
library(mgcv)
```

# Introduction

## big problem
### archy settlement dynamics
Settlement patterns are a basic pillar of the archaeological record, the tool by which we link small scale social processes with large scale patterns we can recover from patterns on the landscape. Archaeological data, and the generative models rooted in anthropological theory we sue to interpete them, can tell us much about the long term behavior of things we see today, such as settlement scaling, resouce exploiation, specialization and exchange group dynamics, and cultural evolution. 
not just settlement patterns but the flows between them

### need space
But often concerns of space, time, and distance are left implicit. 

## Narrower problem
###SIM introduces space, feedbacks between size, location,an dattractiveness
###lots of work on empriical settlement patterns, exploring the roles of distance detterrence size feedbacks and data unceratinty, and the balance of determinism and historicla ocontingency.
### In most of these cases the flows are aggregated, and we assume some aggregate trade and migration flow that we call importance and they combine to influence attractiveenss. But of course several different things can flow over land, and they can interact in nontrivial ways to influence attractiveness. Slow dynamics are based on equilibrium sensing bheavior based on interactio nterms, so it is difficult to interpet them as representing actual change through time on the scales most important ot human societies.


Dynamic spatial iteraction models are a powerful means of estimating flows between discrete spatial zones. Thery can be useful for incorporating spatial richness into existing mathematical models. The spatial interaction model captures the "fast" dynamics -- the balance of flows between locations as a function of their relative size or importance -- and a different model for the "slow" dynaimcs governing how the locations grow or decline because of their differential access to those flows. The flows into each locatio are then summed and used to update the original outflows in an iterative fashion. The slow dynamics are typically a simple equilibrium-seeking behavior, in which the model evolves so as to blanace inflows and outflows. As a result, many archaeological applications of these models should be interepreted as heuristic tools for finding equilibrium settlement distributions, rather than true dynamical models that explicitly resolve the time evolution of settlement systems. 

Allow goods and people to flow between populations in $N$ via an adjacency matrix $\mathbf{E}$, representing a (social) food-exchange network embedded in space. $\mathbf{E}$ is derived from an entropy-maximizing spatial interaction model, which estimates the intensity of interaction between locations as a function of distance and a measure of their mutual "attractiveness" [@Wilson2011EntropyModelling]. Entropy maximization is a means of making unbiased estimates of the most likely distribution of large-scale properties of a system (in this case a spatial network), making the fewest possible assumptions about micro-scale dynamics (social networks) [@Presse2013PrinciplesPhysics]. Models that use entropy maximization to estimate the "fast" flow dynamics and consumer-resource equations such as (1) to represent the "slow" settlement dynamics are known as Boltzmann-Lotka-Volterra models [@Wilson2006EcologicalTheory,Wilson2008BoltzmannSystems], and useful for working with the limited information inherent to the archaeological record [@Bevan2013ModelsEvidence,Davies2014ApplicationAges,Altaweel2015EvaluatingMaximization].

In order to keep them flexible, archaeoliical spatial interacito nmodels are typically hihglu aggregated. The flows are assumed to be some aggregate of trade and migration reflecting the "influence" of each site, and the settlement state variabile that evolves in time is some enralized notion of attractiveness. Whiles tehse generalizations are useful for empricial work, they elide much of the processual complexity that make them useful as a tool for quantitative theory building.

## GAP
###Use the tooling of geogrpahy and economics for distaggregating flows, and incorporate slow dynamcis beyond the bsic equilibrium seeking behavior
### explore different modes of transmpoort, different sectors of interaction
### migration vs trade in archaeology

## summary
###population dynamics for slow, isaggregated flows. Which material flow is more important for determinging settlement patterns, food to people or people to food.
### find that food to people constraints are more important



Sharing and exchange are critical for maintaining population in response to interannual climate variability, although this short term stability can come at the cost of long term environmental degradation [@Janssen2010]. More restricted sharing rules can be effective [@Hegmon1996], but can also be sensitive to the asymmetric accrual of debts if one party's food supply is more volatile than anothers' [@Crabtree2015]. Environemntal context of exchange important [@Freemanetaal2014]. Specifically build on @Anderies2011 which explored the interaction of migration and resource heterogeneity. They used a 3 patch model to assess the role of migration and climate shocks in relation to ecological dynamics and cultural attitudes. This study presents a spatially rich extension that uses spatial interaction model to capture trade and migration flows within a structured population of settlements. 

The network matters. The topology of spatial networks also constrains who can interact with whom, introducing bottlenecks and other structural flow constraints [@Barthelemy2011SpatialNetworks,@qubbaj20111]. Improvements to transportation infrastructure, such as roads and trails, decrease the effective distance between different settlements; failure to maintain these transportation networks increases the effective distance [@McCall1985TheAfrica].

Spatial interaction models are a powerful way of introducing space in mathematical models, and for exploring on the bidirectional feedbacks betwen settlement size and social interaction. Archaeology is embracing the form of constrained spatial interaction modeling developed by Wilson. Regional scale patterns of spatial interaction arise from the decisions of heterogeneous agents interacting with imperfect and incomplete information. They make decisions based on the perceived costs and benefits of interaction, as far as they are able to distinguish them. It is crucial to estimate distribution of each person's subjective predictions about the costs and benefits of social interaction, conditional on the information available to them about each potential destination. Metabolic costs, such as the energy expended producing and transporting food over space where transportation infrastructure is sparse, provide constraints on energy flows in exchange systems [@Drennan1984]. In any particular case, the balance between these costs and the metabolic benefits of social interaction influences whether resources are moved in bulk to populations in need, or whether those populations move themselves to the available resources. 

These Boltzmann-Lotka-Volterra (BLV) style models use maximum entropy spatial interaction models to allocate flows between a spatially structured metapopulation, and Lotka-Volterra style consumer-resource equations to govern the growth of the populations. Lotka-Volterra equations are used in ecology to model energy flows in a food web. More generally, these models can represent energy flows in any social-ecological system, such as an agricultural settlement consuming resources from its hinterland. These equations are able to capture the dynamic feedbacks between settlements and the networks connecting them. Recent work in archaeology has expanded these models to allow the networks to further evolve, as routes that are more often used to connect important sites become themselves important, which in turn shapes the growth of settlements close to those routes. Past work has shown how stable routes and sets of routes can develop in mountainous topography, where physical constraints on movement are able to constrain the possible routes between settlements. 

Here, I extend this approach to examine how settlement systems evolve in response to patterns of environmental variability. Rather than leaving the carrying capacity of our population of settlements to remain fixed, we allow it to vary over space and in time. We examine how different patterns of spatio-temporal change lead to different settlement patterns and spatial network. We use a simple computatational modeling approach to facilitate a broad range of exploration, while maintaining interpretive clarity. We expect that different patterns, such as fixed oscillations, to lead to different stable patterns of spatial networks, whose dynamical behavior feeds back to influence settlement dynamics. In this way we seek to model the potential for "inertia" in settlement patterns, complicating the relationship between environmental forcing and social dynamics. Finally we allow for bidirectional feedbacks between human populations and the environment, exploring the potential for nonlinear social-ecological dynamics.

This research highlights dynamics \textit{of} networks, not dynamics \textit{on} networks. The approach implicit in many conceptual and mathematical models of networks, and social-ecological networks in particular, treats them as static (if nontrivial) structures on which some dynamic of interest plays out [@Wilson2008BoltzmannSystems]. These structures only change in time to the extent that the researcher intervenes by adding or removing nodes and edges manually. This view is common in archaeology [@Brughmans2010ConnectingAnalysis], and is understandable given the fragmentary and time-averaged nature of the archaeological record. Instead, this approach treats social networks as dynamical systems with continuous flows of matter, information, and energy in constant interaction with their ecological and social environments. Improved representations of social and biophysical dynamics will not only enhance understanding of the empirical settlement patterning in the archaeological record, but will also facilitate future cross-cultural and inter-regional comparisons by providing a shared set of questions and methodological tools for answering them.

# Methods

## Population growth and decay -- the "slow" dynamics

I explore a simple model of human settlements and their agricultural hinterlands. The basic unit is a settlement, representing any urban or semi-urban population in an agrarian society that consumes food from its hinterland to support a population of non-farmers. The population engaging directly in food production is left external to the model, and it assumed that a fixed volume of surplus food resources are produced in the hinterland each year. Instead the model tracks the population of merchants, craftspeople, and elites who rely on this agricultural surplus [@Turchin2011]. The core dynamic of the urban population is represented as

$$
\dot{N} = rN,
$$
where $\dot{N}$ is the time rate of change of population $N$ and $r$ is the realized growth rate. The growth rate depends on the amount of resources consumed by $N$ as

$$
r =
  \begin{cases} 
      \epsilon \left(X -  N \right) & \text{if} \space \space\epsilon \left(X - N\right) < r_{\mathit{max}} \\
      r_{\mathit{max}} & \text{otherwise},\\
   \end{cases}
$$
where $X$ is the amount of available resource surplus, $\epsilon$ is a parameter that controls the rate at which the surplus increases or decreases the population, and $r_{\mathit{max}}$ is the maximum growth rate. This equation states that the population grows or shrinks in proportion to its consumption of resources, but it cannot grow faster than a biological maximum rate. For simplicity, assume that $X$ is scaled to units of $N$ so that one unit of resource is sufficient to maintain one unit of population. The resulting process is a hybrid of exponential and logistic growth, with the population growing quickly when consumption is far above population, and more gradually when consumption is close to the current population (Figure \@ref(fig:growth-model)). $X$ acts as a carrying capacity, but unlike with the population's approach to this limit can be much less gradual than in logistic growth, but not as rapid as exponential growth. The population saturates and growth declines to nothing over a period of two to three generations.

```{r}
grow <- function(net, epsilon = .0001, rmax = .02){
  net %N>%
     mutate(population_new = population + population * pmin(epsilon * (harvest - population), rmax) - migrant_production + immigrants,
           population_new = if_else(population_new > .0001, population_new, .0001),
           eq = if_else(abs((population_new - population) / population) > 0.001, 0, eq + 1),
           population = population_new)
}
```


```{r growth-model, fig.cap='Simulations from the growth model, compared with exponential and logistic growth, for two levels of $X$. When $N$ is near $X$, it resembles logistic growth. When $N$ is small relative to $X$, the population grows exponentially.'}

x_text <- tibble(x = c(350, 400), 
       y = c(100,350), 
       X = c(250, 500),
       text = paste('X = ', X))

tibble(X = c(250, 500)) %>%
  mutate(exponential = map(X, function(x) accumulate(1:499, ~ pmin(. + . * .02, x), .init = 10)),
         hybrid = map(X, function(x) accumulate(1:499, ~ . + pmin(.0001 * (x - .), .02) * .,.init = 10)),
        logistic = map(X, function(x) accumulate(1:499, ~ . + .02 * . * (1 - . / x),.init = 10))) %>%
  gather(type, N, exponential:logistic) %>%
  unnest(cols = c(N)) %>%
  mutate(time = rep(1:500, 6)) %>%
  ggplot(aes(time, N)) +
  geom_line(aes(color = type, group = type), size = 1.2) +
  scale_color_viridis_d(direction = -1, name = 'Growth function') +
  facet_wrap(~X) +
  geom_text(data = x_text, aes(x = x, y = y, label = text)) +
  labs(x = 'Year', y = 'Population') +
  theme_classic() +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank())
```

Rather than a single settlement-hinterland system, the model represents a network of hundreds of interacting settlements and hinterlands (Figure \@ref(fig:spatial-domain)). Each settlement is positioned at the center of a hexagonal hinterland of radius 5km (a one-two hour walk). Settlements extract the agricultural surplus from their local hinterland as well as those of nearby settlements. Settlements compete with one another for the fixed amount of resources produced in the hinterlands, a dynamic analagous to the "competition for resources" models common in ecology. For simplicity the harvest of resources from hinterlands is referred to as "trade", although it generally reflects any movement of food from one location to a population center in another, such as non-market forms of exchange such as sharing, exchange, or tribute. Not only do settlements interact indirectly with one another by harvesting the same hinterland, but also directly by exchanging population through migration Each model year, a fixed proportion of a settlement's population leaves each city. These migrants select their destination based on the size and distance of potential migration destinations and the relative per capita resource extraction rate of each settlement.



```{r constants}
radius <- 5 # radius for each hinterland tile
phi <- radius * 0.5
pop_start <- 25 # starting population per settlement
food_start <- 200
```

```{r settlement_setup}
hinterlands <- c(40,-69, -40,-69,-80,0,-40,70,40,69,80,0,40,-69) %>% # changing one 69 in the top corner to a 70 helps for some reason
  matrix(nrow = 7, byrow = 2) %>%
  list %>%
  st_polygon %>%
  st_make_grid(cellsize = radius * sqrt(3), square = FALSE) %>% # st_make_grid wants the short diagonal
  st_sf

n <- nrow(hinterlands)

pts <- hinterlands %>%
  st_centroid %>%
  st_coordinates

settlements <- hinterlands %>%
  st_centroid %>%
  st_distance %>%
  round(2) %>%
  replace(. == 0, 999) %>%
  as_tbl_graph %>%
  mutate(id = 1:n(),
         population = pop_start,
         food = food_start,
         x = pts[,1], 
         y = pts[,2],
         eq = 0) %E>%
  rename(distance = weight) %>%
  mutate(distance = if_else(distance == 999, 0, distance),
         trade_flow = 0,
         migrant_flow = 0) 

prune <- function(net, beta, tolerance = 0.001){
  net %E>%
    filter(distance < -log(tolerance) * beta)
}
  
# the larger your domain grows the more potential connections there will be, which can
# increase computational costs significantly. We can fix this by filtering out edges defined
# at a certain threshold. if we're using the exponetial beta parameterization, we can truncate using the following command, where the term in the log is the minimum distance effect we want to capture. We'll set it to .005, which if we assume food is 200 gives us 1. so at a maximum parameterization of beta = 20, truncating the network at this distance serves to elimitate flows that will be lses than .5% or 1 food.

paths <- settlements %E>% 
  filter(near(distance, sqrt(3) * radius, tol = .1)) %>%
  igraph::as.undirected() %>%
  as_tbl_graph()
```


```{r spatial-domain, fig.cap="Spatial domain for the simulation experiments. The hinterlands are 300 evenly-sized hexagons with radius 5km arranged in a continuous tiling with a total size of approximately 19,500 km2. Settlements are arranged in a triangular lattice located at the centroids of each hexagonal tile, and are connected by a system of physical paths joining each settlement to its six nearest neighbors."}
ggraph(paths, x = x, y = y) +
  geom_sf(data = hinterlands, fill = NA, color = 'grey65') +
  geom_edge_link(alpha = .5) +
  geom_node_point() +
  coord_sf(datum = NA) +
  theme_void()
```

The simple mathematical model presented above can thus be extended into a social-ecological network of multiple interconnected consumer-resource systems. First, disaggregate $X$ and $N$ into $X_i$ and $N_j$, representing the resource surplus at location $i$ and the population at location $j$. Then, introduce two flow matrices $\mathbf{T}$ and $\mathbf{M}$ that represent trade and migration flows, respectively, such that the volume of resources produced in hinterland $X_i$ that are consumed by the population in settlement $N_j$ is $T_{ij}$, and the number of migrants moving from settlement $N_i$ to $N_j$ is $M_{ij}$. Assuming a per capita out migration rate of of $\nu$, the expanded version of Eq. 1 and 2 is thus:

$$
\dot{N_j} = rN_j - \nu N_j + \sum_i M_{ij}  ,
$$
$$
r =
  \begin{cases} 
      \epsilon \left(\sum_i T_{ij} -  N_j \right) & \text{if} \space \space\epsilon \left(\sum_i T_{ij} -  N_j\right) < r_{\mathit{max}} \\
      r_{\mathit{max}} & \text{otherwise}.\\
   \end{cases}
$$
Together, these equations state that the population of each settlement grows according to the total inflow of resources from each hinterland and the total inflow of migrants from each settlement. Next, we show how these resource and migrant flows change over time in response to these population dynamics.

## Trade, migration, and spatial interaction -- the "fast" dynamics.

The model tracks two kinds of spatial flows -- movement of surplus resources from hinterlands into settlements and movement of people between settlements -- using separate spatial interaction models. Both cases use similar "production-constrained" spatial interaction models. The general approach, first used in archaeology by @Rhilandwilson, takes a fixed volume of flow "produced" at each location and allocates it among all potential destinations in proportion to the relative costs and benefits of interacting with each. Benefits are assessed as a power function of one or more settlement-level variables (such as size) that attract flows, and costs are assessed as a negative exponential function of distance (Figure \@ref(fig:functional-forms)). Two parameters, $\alpha$ and $\beta$, control the strength of these influences. When $\alpha > 1$ the benefits of interaction exhibit increasing returns to scale. $\beta$ is in units of distance, and can be interpreted as the distance at which the strength of interaction decays to about two-thirds of its original value. 

```{r functional-forms}
p1 <- expand_grid(population = 0:10000,
       alpha =  c(1, 1.05, 1.1, 1.15)) %>%
  mutate(attractiveness = population ^ alpha) %>%
  mutate(alpha = as.ordered(alpha)) %>%
    ggplot(aes(population, attractiveness, color = alpha, group = alpha)) +
  geom_line(size = 1.2) +
  scale_color_viridis_d(name = expression(italic(alpha))) +
  labs(x = 'Population', y = 'Interaction strength') +
  theme_classic()

p2 <- expand_grid(distance = 0:100,
       beta =  c(1, 5, 10, 15, 20)) %>%
  mutate(deterrence = exp(-distance / beta)) %>%
  mutate(beta = as.ordered(beta)) %>%
    ggplot(aes(distance, deterrence, color = beta, group = beta)) +
  geom_line(size = 1.2) +
  scale_color_viridis_d(name = expression(italic(beta))) +
  labs(x = 'Distance (km)', y = 'Interaction strength') +
  theme_classic()



p1 / p2 + plot_annotation(tag_levels = 'A')
```

The spatial interaction model for trade is a simple "gravity" model, in which settlement population $N$ is the only variable determining a settlement's attractiveness. Thus the flow of resources from hinterland $i$ to settlement $j$, is

$$
    T_{ij} =  X_i  \frac{N_j^{\alpha_1} \exp\left(-c_{ij} / \beta_1 \right)}{ \sum_k N_k ^ {\alpha_1} \exp \left( -c_{ik} / \beta_1 \right)},
$$
where $X_i$ is the amount of surplus resource produced in hinterland -- the "production" term that is "constrained" in the model, and $c_{ij}$ is the cost of moving from $i$ to $j$ (distance in kilometers). The terms in the fraction simply assess the relative costs and benefits, with the numerator representing the utility of moving food to settlement $i$ and the denominator the sum of the utilities for all potential destination locations, together ensuring that the total outflows equal the total resources in $X_i$.

```{r}
trade <- function(net, alpha, beta, phi = radius / 2){
  net %E>%
   mutate(trade_utility = .N()$population[to] ^ alpha * exp(-if_else(distance > 0, distance, phi) / beta))  %N>%
    mutate(trade_balance = centrality_degree(weights = trade_utility, mode = 'out', loops = TRUE),
           trade_production = food) %E>%
    mutate(trade_flow = .N()$trade_production[from] * trade_utility / .N()$trade_balance[from]) %N>% 
    mutate(harvest = centrality_degree(weights = trade_flow, mode = 'in', loops = TRUE))
}
```

 The migration flows depend in part on the trade flows, and are modeled in a similar fashion. The number of migrants moving from settlement $i$ to $j$ is 

$$
  M_{ij} =  \nu N_i \frac{N_j^{\alpha_1} W_j^{\alpha_2} \exp\left(-c_{ij} / \beta_2 \right)}{ \sum_k N_k^{\alpha_1}  W_k^{\alpha_2} \exp \left( -c_{ik} / \beta_2 \right)},
$$
where $\nu N_i$ is the number of migrants originiating in $i$ and $W_j = \sum_iT_{ij}/N_j$ is the per-capita welfare of $j$, defined as the ratio of trade inflows to population. Unlike in the trade equation above, the attractiveness of a given settlement as a migration target depends on both its population size and its welfare. Migrants will thus seek out destinations with lots of well-fed people, and the relative values of $\alpha_1$ and $\alpha_2$ determine the relative importance of each factor.


```{r}
migrate <- function(net, alpha1, alpha2, beta, nu = .05){
  net %E>%
    mutate(migrant_utility =.N()$population[to] ^ alpha1 * (.N()$harvest[to] / .N()$population[to]) ^ alpha2 * exp(-distance / beta)) %N>%
    mutate(migrant_balance = centrality_degree(weights = migrant_utility, mode = 'out', loops = TRUE),
           migrant_production = population * nu) %E>% 
    mutate(migrant_flow = .N()$migrant_production[from] * migrant_utility / .N()$migrant_balance[from])  %N>%
    mutate(immigrants = centrality_degree(weights = migrant_flow, mode = 'in', loops = TRUE))
}
```

In summary, the flow of resources from each hinterland to each settlement is determined by Eq XXXX, which depends on the underlying distribution of resources and settlement populations. Then, the flow of migrants between settlements is determined by Eq XXX, based on the settlement populations and the flow of resources. Finally, the populations of the settlements grow both by consuming trade resources and by accepting new migrants, and the new population distribution will feed back to influence future trade and migrant flows. The entire system is complicated web of nonlinear, as the growth and decline of settements can potentialy depend on all other settlements. The complexity of this system increases geometrically as the number of settlements increases, precluding exact analytic solutions. We must instead leverage computational simulations to capture these complex interactions numerically. Now we use simulation to better understand the behavior of this model in different enviromental contexts.

```{r}
run_sim <- function(net, alpha1 = 1.15, alpha2 = 1, beta1 = 5, beta2 = 10, nu = .05){
  new_net <- net %>%
    trade(alpha = alpha1, beta = beta1) %>%
    migrate(alpha1 = alpha1, alpha2 = alpha2, beta = beta2, nu = nu) %>%
    grow %>%
    select(-c(trade_balance:trade_production, migrant_balance, population_new)) %E>%
    select(-c(trade_utility, migrant_utility)) %>%
    activate('nodes')

   if(sum(pull(new_net, eq) >= 100) < n){
     return(new_net)
   } else return(done(new_net))
}
```


```{r, eval=FALSE}
plan(multisession)

param_sweep <- expand_grid(beta1 = c(5, 10, 15, 20),
                           beta2 = c(5, 10, 15, 20),
                          alpha1 = c(1, 1.05, 1.1, 1.15),
                          alpha2 = c(0, 1, 1.05, 1.1, 1.15),
                          nu = c(.05, .5, 1)) %>%
  filter(beta1 <= beta2) %>%
  mutate(sim = future_pmap(list(beta1, beta2, alpha1, alpha2, nu, m_max), function(a,b,c,d,e,f) reduce(1:2000, ~run_sim(., beta1 = a, beta2 = b, alpha1 = c, alpha2 = d, nu = e, m_max = f), .init = settlements), .progress = TRUE))

saveRDS(param_sweep, 'param_sweep')
```

# Results

$\beta$ is particularly relevant here as it determines the impact of distance on flow intensity, and can be varied to represent the different costs of moving food versus people across an exchange network.


As a shorthand call beta1 "transport" ease and beta2 "travel" ease

We only assume that all $\alpha >= 1$, that is there are positive returns to scale in attractiveness, and Here I focus on the parameter space where $\beta_1 \leq \beta_2$, because moving bulk food supplies over the landscape should be more difficult than moving people. 


First I explore baseline sensitivity of the model to key tuning parameters. interaction parameters $\beta_1$ and $beta_2$ governing the distance deterrence for trade and migration, respectively.

```{r}
param_sweep <- readRDS('param_sweep')
```


```{r}
nystuen_dacey <- function(net, mode = 'trade'){
  net %E>%
  group_by(from) %>%
  {if (mode == 'trade') filter(., trade_flow == max(trade_flow)) else filter(., migrant_flow == max(migrant_flow))} %>%
  ungroup %>%
  filter(.N()$population[from] < .N()$population[to]) %N>%
  mutate(terminal = node_is_sink()) %>%
  convert(to_undirected) 
}

nd_graphs <- param_sweep %>%
  mutate(trade = map(sim, nystuen_dacey),
         migrants = map(sim, nystuen_dacey, mode = 'migrants')) %>%
  select(beta1:m_max, trade, migrants)
```


```{r}
param_dat <- param_sweep %>%
   mutate(nodes = map(sim, as_tibble, 'nodes')) %>%
  mutate(population = map_dbl(nodes, ~sum(.$population)),
         prob_vect = map2(nodes, population, ~ (.x$population) / .y),
         entropy = map_dbl(prob_vect, ~ -sum(. * log(.)) / log(300)),
         count = map_dbl(nodes, ~sum(.$population > 1))) %>%
  select(beta1:m_max, population, entropy, count)

node_dat <- param_sweep %>%
  mutate(nodes = map(sim, as_tibble, 'nodes')) %>%
  select(beta1:m_max, nodes) %>%
  unnest(col = c(nodes)) %>%
  select(beta1:m_max, population, x, y, harvest, immigrants)

edge_dat <- param_sweep %>%
  mutate(edges = map(sim, ~activate(., 'edges') %>% filter(trade_flow > 1 | migrant_flow > 1) %>% as_tibble)) %>%
  select(beta1:m_max, edges)

rm(param_sweep)
```


## The movement of food to people influences settlement territory size

How does the cost of moving food and people over distances, as encoded in the $\beta$ parameters, influence settlement patterns at equilibrium? The $\beta$ parameters are the primary way space is introduced into the model. Critically, the costs -- be they in time, money, or energy -- of moving food and other resources from hinterlands to settlements will be different from the costs of moving people between settlements. The balance of these cost factors can introduce complexity via non linear interactions between the two. A settlement's trading catchment can be different from their migration catchment, so nontrivial spatial patterns can result from these interactions. 

With baseline values of $\alpha_1 = 1.15$, $\alpha_2 = 1$, $m_{max} = 0.05$ (population scaling and no hunger based migration). Increasing $\beta_1$, allowing food to be moved further distances, decreases the number of inhabited settlements at equilibrium and increases the size of these centers. The settlements also move closer to the center of the domain, as that supplies the maximum access to resources. There is a clear spatial bifurcation at $5 < \beta_1 < 10$. This is the difference above and below the distance of the nearest cell neighbor given the cell resoltion (nearest distance is approximately 8km).

## Migration influences to distribution of population

Holding $\beta_1$ constant and varying $\beta_2$ allowing migrants to move further than food. The result is a pattern of concentrric rings at low values of $\beta_1$. When it is difficult to move food over space, migration acts in lieu of food tranpsort by increasing the size of the terminal centers (allowing population to move to populated zones). But at beta2 = 15 there is a switch, where now the center is filled with multiple settlements of similar size in a hexagon pattern. The number of settlemetns in this central zone increases with increasing migration. IT seems that this might be a rsult of the size and shape of the spatial domain, as at long distance interaction the size and shape of the domain more strongly constrains the possible configurations. These inner zones decrease at increasing beta1, suggesting that what's happing is at low values of beta1 settlements must extact from their immediate area. Settlements at the edge get inital advangtages because they have fewer nearby cities competeing with them for resources. At low beta2, this doesn't matter as much, but at high beta2 it sets of a feedback because population migrates to the sites with initial advantages. When beta1 is higher, beta2 doesn't neceesaryily change the patterns that much, just serves to concentrate more poeple in fewer core settlemetns that are closer together. At the highest values of beta and beat2, the hexagonal core returns, if smaller than in the low beta1 case. The key feature to my mind is the bifurcation between $\beta_1$ at 5 and 10.  

AS migration increases the central settlement splits into a greater number of smaller settlements.

If transportation technology allows food to move more easily between scales, that process dominates and the system organizes around the territorial reach of each settlements, and the resulting feedbacks with food flows and size predominate. When beta1 is low/transport tech is low, it is harder to move food between terirtories and migration predominates in shaping settlement patterns.Likewsie, there isn't much of adiffernce between the 10 and 15 threshold because that's still between settlements (the distances are 8 and 17). So that middle zone thing only happens when alpha 3 is zero. That is it is a result of the population seeking behavior. When we allow people to avoid locations near carrying capacity, the system is allowed to balance out better. Although these are edge effects, this does have important implications for for geographically bounded systems. Variations in transport capacity only matter up to the constraint of maximum travelable distance. decreasing transport and travel costs.

So generally we see that the costs of moving resources from hinterlands to settlements effects territory size, which is the primary determinate of equilibrium site size and spatial configuration. However, migration has a more subtle effect of redistributing people among settlements, although the absolute population is less impacted.
```{r}
knitr::knit_exit()
```
```{r, fig.cap = "Food to people, vs people to food"}
a <- node_dat %>%
  filter(alpha1 == 1.15, alpha2 == 1, nu == 0.05, beta2 == 20) %>%
  group_by(beta1, beta2)%>%
  arrange(population) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population))+
  scale_size_area() +
  scale_color_viridis_c(guide = 'legend') +
  coord_equal() +
  theme_void() +
  facet_wrap(~beta1, nrow = 1)

b <- node_dat %>%
  filter(alpha1 == 1.15, alpha2 == 1, nu == 0.05, beta1 == 5) %>%
  group_by(beta1, beta2)%>%
  arrange(population) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population))+
  scale_size_area() +
  scale_color_viridis_c(guide = 'legend') +
  coord_equal() +
  theme_void() +
  facet_wrap(~beta2, nrow = 1)

a / b + plot_annotation(tag_levels = 'A')
```



Rank size distribution. Increasing $\beta_2$ increases the convexity of the rank size distribution. Increasing $\beta_1$ decreases it

```{r}
node_dat %>%
  filter(alpha1 == 1.15, alpha2 == 1, nu == 0.05, beta1 == 5) %>%
  group_by(beta1, beta2) %>%
  arrange(-population) %>%
  mutate(rank = 1:n()) %>%
  ggplot(aes(rank, population)) +
  geom_line() +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~beta2, scales = 'free_y') +
  geom_smooth() +
  theme_classic()
```

For the following discussion, I generally constrain $\beta_1 = 5$, meaning that sites can only directly access the immediate neighboring hinterlands if they're of the same size.


## Population-based migration increases settlement heirarchy, welfare-based migration reduces it


Introducing scaleing parameters to the population size doesn't change the basic interaction between the $\beta$ parameters, but does impact the size heirarchy 

the center zone behavior arises if we set alpha1=alpha2, and turn on alpha3. that is all the alphas are the same, then the population center hexagon arises much faster, at lower values of beta2, and is much larger. It goes away if we turn on scaling for gamma. This suggests the case where movement is easy, but there are few advantages to living in larger sites, and what adantages do arise are equalized by the alpha3 bejavior




Constraining beta1 to 5 and beta2 to 10, then exploring alphas. All else being equal, we'd assume $\alpha_1 = \alpha_2$ since they both relate the the scaling with population size, and the differences in the importance of population size between travel and transport attractiveness would be introduced by the prefactor (which get's cancelled here given the normalization). Nevertheless we explore different combinations of alphas. Generally, increasing eigher alpha increases the concentration of popualtions in fewer centers. As before, the settlemetns near the edge grow higherst, because there is less competition for access to resources. Turning on alpha 3, so that people avoid crowded locations, considerably icnreases the complexity of the system. This removes the apparent similarity between the alphas, with more nonlinear responses

We also explore the equilibria when $\alpha_2 = 0$, dexcribing a system in which only population size and not food availability influences migration.

```{r}
node_dat %>%
  filter(beta1 == 5, beta2 == 10, nu == 0.05) %>%
  group_by(alpha1, alpha2)%>%
  arrange(population) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population))+
  scale_size_area() +
  scale_color_viridis_c(guide = 'legend') +
  coord_equal() +
  theme_void() +
  facet_grid(rows = vars(alpha2), cols = vars(alpha1))

node_dat %>%
  filter(beta1 == 5, beta2 == 15, nu == 0.05) %>%
  group_by(alpha1, alpha2)%>%
  arrange(population) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population))+
  scale_size_area() +
  scale_color_viridis_c(guide = 'legend') +
  coord_equal() +
  theme_void() +
  facet_grid(rows = vars(alpha2), cols = vars(alpha1))
```



## Food availability and decision to migrate
If beta2 is high, having a high nu value (migration happens slower) arrives at the same equilibrium as having no pulse migration whatsoever. Introducing nu breaks some of the symmetry in the pther settlement patterns

```{r}
node_dat %>%
  filter(beta1 == 15, beta2 == 20, alpha1 == 1.1, alpha2 == 1) %>%
  arrange(population) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population))+
  scale_size_area() +
  scale_color_viridis_c(guide = 'legend') +
  coord_equal() +
  theme_void() +
  facet_warp(~nu)
```


## Equilibrium behavior


let's analyze the patterns statistically. we calculate the total population of each simulation, and the relative shannon entropy of the population distribution, and index of dispersion. Values of 0 indicatea fully concentrated in a single point systen, 1 is as dispersed as possible.

Remember that high population usually means more dispersion, that means more settlements. maybe some measure of the heirarchy

So with constant low migration higher populatio nis related to low beta1, high beta2. Alpha1 increases migration at lower values but it is nonlinear (reflecting underlying power law). Alpha 2 has almost no effect. That said, these parameters only explain ca 20% of the deviance

```{r}
param_dat %>%
  filter(nu == 0.05) %>%
gam(population ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4),
          data = .) %>% plot
```

If we look at the pulse migration context, alpha 2 matters a bit more but the effect is still weak. Interestingly, nu also plays a small role. so basically nu and related parameterizations have little effect on the equilibrium, but probably more of an impact on the dynamics. Beta1 isless distinct here, looks like a population peak at beta= 15
```{r}
param_dat %>%
gam(population ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4) + s(nu, k = 3),
          data = .) %>% plot
```
Similar picture with more complex interactions.
```{r}
param_dat %>%
  filter(nu == 0.05) %>%
gam(population ~ s(beta1, beta2, k = 8) + s(alpha1, alpha2, k = 8),
          data = .) %>% plot(scheme = 1)
```

The parameters do a mych better job of explaining entropy, approximately 90% of the deviance is expalined. Beta1 is the strongest determinate of entropy. Low beta1 results in high entropy (high despersion), and the relationship is nonlinaer. Increasing beta2 has a small linear increase in dispersion. The ninlinear break between 5 and 10 beta1 (around the difference in cell size) is visible here. Alpha1=1 slightly increases the dispersion, but as soon as scale economies are increased by raising it the strength of the interaction decrases. Alpha2 linearly increases dispersion
```{r}
param_dat %>%
  filter(nu == 0.05) %>%
gam(entropy ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4),
          data = .) %>% plot
```

Now for the case with pulse migration. same basic relationship as before. increasing nu slightly decreases dispersion, but the effect is small. Again, the lack of difference between the m_max cases suggests that variable influences the transient dynamics rather than the equilibrium.
```{r}
dat %>%
gam(entropy ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4) + s(nu, k = 3),
          data = .) %>% plot
```

Finally we look at relationships to the count of sites with popualtion > 1 at equilibrium. Here beta1 again, at low values increases the count. Beta2 increases, and below 10 it more decreases the count. So if migration is difficult, fewer site grow. Alpha1 matters alot. When alpha1 is 0, so there are no returns to population, much more sites surviv to equilibrium. At increasing levels of alpha2, this efefct is less pronounced. Increasing nu decreases count, but only slightly (so slower migration production arises the fewer sites there are.)

```{r}
param_dat %>%
gam(count ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4) + s(nu, k = 3),family = poisson, data = .) %>% plot
```

That was all for the pulsemigration case. Without that, there is a thershold at beta1 = 15, beyond which it doesn't change the count of sizes that much. The other relationships are similar, although beta2 is more pronounced. Alpha2 also matters here, unlike in other cases. Increasing the returns to food supply increases the count at equilibrium.
```{r}
param_dat %>%
  filter(nu == 0.05) %>%
gam(count ~ s(beta1, k = 4) + s(beta2, k = 4) + s(alpha1, k = 4) + s(alpha2, k = 4),family = poisson, data = .) %>% plot
```

So looking at the parametr combinations that lead to high poplation or high concentration ... low beta1 and high beta2 have the highest population, more sensitive to beta1, and alphas set to 0, and alpha 2 more important to be low than otherwise. This is what we saw in the graphs with the large central areas, which reflect low transport costs and low returns to scale. For the entropy case, low beta1 means higher etnropy (ie more dispersion). Beta2 maetters less, and again with low or no scaling. having alpha3 in the mix also increases dispersion, all as we'd expect.

So most dispersed (high entropy) patterns arise when territories are small, migration is eaisy, and migration is influence more by food access then by populatoin. Especially if we assume migration is a fast response to carrying capacity. So basically we have a lot of people moving around right as carrying capacity is reached.



Enropy is lowest (most concentrated) when movement is easiy in eigher domain, and people only make movement decisions based on size sizes, and migration response to food stress is gradual. This means people are attrated to high population settlements, they can move easily to them


intrestingly, there seems to be very little variability around beta1 is 15, that's when we get to 3 city attractor. beta 2 increasing slightly decrases entropy, but not as strongly as beta1. having alpha3 in the mix slightly increases the entropy, but the boxplots are still within the range of one another as we might expect

So what does this all leave us with. Beta1 governs the spacing of the centers, beta2 and alphas more impact the population distirbution. Alphas specifically increase the heirarchies

So generally we see more settlements with decreasing beta. With increasing alpha we get a more defined heirarchy of site sizes.

Past a beta of .4 or whatever, the patterns don't change. this is because at this point, the distance decay function attentuates at or below the baseline 10km distance between settlements. Important to not here that the interperation of the value of beta depends on the characteristic length scale.



We can agian confrim the genral patterns above by looking at the nystuen dacey graphs. Confirming that the mass of same sized sites reflects that they have no nystuen dacey graph for trade, ie they're all competing for the same land and no clear winner gets the flows. We do get migrants out from the core to the edge sites, hence the hexagonal pattern of the core zone. these patterns arent particularly sensitive to the alphas.
```{r}
#trade
nd_graphs %>%
  filter(alpha1 == 1.15, alpha2 == 1, m_max == .05)  %>%
  mutate(nd = map(trade, as_tibble, 'edges')) %>%
  select(beta1:m_max, nd) %>%
  unnest(col = c(nd)) %>%
  tbl_graph(nodes = as_tibble(paths, 'nodes'), edges = .) %>%
  ggraph(x = x, y = y) +
  geom_edge_link(alpha = .5) +
  facet_edges(beta1 ~ beta2) +
  coord_equal() +
  theme_void()

#migrants
nd_graphs %>%
  filter(alpha1 == 1.15, alpha2 == 1, m_max == .05)  %>%
  mutate(nd = map(migrants, as_tibble, 'edges')) %>%
  select(beta1:m_max, nd) %>%
  unnest(col = c(nd)) %>%
  tbl_graph(nodes = as_tibble(paths, 'nodes'), edges = .) %>%
  ggraph(x = x, y = y) +
  geom_edge_link(alpha = .5) +
  facet_edges(beta1 ~ beta2) +
  coord_equal() +
  theme_void()
```

But remember, in the case of the migration flows, the nd graph might be misleading because you can have significant flows of migration between the large cities, even if the nystuen dacey graph hides this.


So from this we see that a bif proportion of the migrant flows go inward. Is this ok? its consistent with the potential behavior of the qubbaj model. But perhaps not if we introduce bariable migration


"jumps" in the parameter space (clarke and wilson 1983 or 1985, regional science). basically the relationships between alpha and beta are consistent for this

Explor the rank size distirbution

Hard to see here, but for beta = 1 we can really see the effect of migration, longer migration distance leads to some pooling in center.
But in general, variation due to trade swamps that from migration, becuase trade also shapes migration but less so the other way around.





We don't see ideal free distribution

There's not a clear relationship between size and local productivity. what about in the region?


The larger one's hinterland is, the higher the population. not suprising




what about edges

```{r, include = FALSE}
tes <- edge_dat[[74,7]] %>% filter(from != to)
  
m1 <- glm(trade_flow ~ log(distance) + as.factor(from) + as.factor(to), data = tes)#gam(trade_flow ~ s(distance) + as.factor(from) + as.factor(to), data = tes)
summary(m1)
gam.check(m1)

plot(m1)
ggplot(aes(distance, trade_flow)) + geom_point() + geom_smooth()
```


## now add time
also thinking about running these experiments with just a single city
the problem is that cities die out early and don't have enough time 

```{r}
sim <- settlements %>%
      prune(beta = 15, tolerance = .001) %N>%
  list(., ., .) %>%
  tibble(net = .,
         m_max = c(0.05),
         nu = c(.02, .06, .12)) %>%
  mutate(sim = map2(net, nu, function(x, y) accumulate(1:1000, ~run_sim(.x, m_max = .5, nu = y), .init = x)) )
  
```



```{r}
sim %>%
  select(-net) %>%
  mutate(sim = map(sim, ~map(., as_tibble, 'nodes') %>% bind_rows(.id = 'time'))) %>%
  unnest(cols = c(sim)) %>%
  mutate(time = as.numeric(time), nu = as.factor(nu)) %>%
  ggplot(aes(time, population, group = id)) +
  geom_line(alpha = .2) +
  facet_wrap(~nu) +
  theme_classic()


sim %>%
  select(-net) %>%
  mutate(sim = map(sim, ~map(., as_tibble, 'nodes') %>% bind_rows(.id = 'time'))) %>%
  unnest(cols = c(sim)) %>%
  mutate(time = as.numeric(time), nu = as.factor(nu))  %>%
  group_by(nu) %>%
  filter(time == max(time)) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(size = population, color = population)) +
  scale_color_viridis_c() +
  scale_size_area() +
  facet_wrap(~nu)+
  coord_equal()
```


```{r}
sim_dat <- sim %>%
  map(as_tibble, 'nodes') %>%
  bind_rows(.id = 'time') %>%
  mutate(time = as.numeric(time))
  
sim_dat %>%
  ggplot(aes(time, population, group = id)) +
  geom_line(alpha = .2) +
  theme_classic()

sim_dat %>%
  ggplot(aes(harvest, population, group = id, color = time)) +
  geom_path(alpha = .2) +
  scale_color_viridis_c() +
  theme_classic() +
  coord_fixed()

sim_dat %>%
  ggplot(aes(immigrants, population, group = id, color = time)) +
  scale_color_viridis_c() +
  geom_path(alpha = .2) +
  theme_classic() +
  coord_equal()
```

so without scalking behavior you get the crazy initial growth but then it doesn't maintain. with scaling behavior it drops back off
```{r}
sim4 %>%
  map(as_tibble, 'nodes') %>%
  bind_rows(.id = 'time') %>%
  mutate(time= as.numeric(time)) %>% 
  ggplot(aes(time, (population), group = id)) +
  geom_line(alpha = .2) +
  theme_classic()

sim4 %>%
  map(as_tibble, 'nodes') %>%
  bind_rows(.id = 'time') %>%
  mutate(time= as.numeric(time)) %>% 
  ggplot(aes(time, (immigrants), group = id)) +
  geom_line(alpha = .2) +
  theme_classic()
```


is there more of a population heirarchy here?
```{r}
last(sim4) %>%
  nystuen_dacey() %>%
  ggraph(x = x, y = y) +
  geom_edge_link(alpha = .5) +
  scale_size_area() +
  geom_node_point(aes(size = population))+
  coord_equal() +
  theme_void()

last(sim4) %>%
  nystuen_dacey(mode = 'migrants') %>%
  ggraph(x = x, y = y) +
#    geom_sf(data = spatial_patterns, aes(fill = grf_100)) +
  geom_edge_link(alpha = .5) +
  scale_size_area() +
  geom_node_point(aes(size = population))+
  coord_sf(datum = NA) +
  scale_fill_scico(palette = 'bamako') +
  theme_void()

last(sim4) %E>%
  filter(trade_flow > 1) %>%
  arrange(trade_flow) %>%
  ggraph(x = x, y = y) +
#    geom_sf(data = spatial_patterns, aes(fill = grf_100)) +
  geom_edge_link(aes(color = trade_flow), width = 1.2) +
  scale_size_area() +
  scale_edge_color_viridis() +
  geom_node_point(aes(size = population))+
  #coord_sf(datum = NA) +
  scale_fill_scico(palette = 'bamako') +
  coord_equal() +
  theme_void()

last(sim4) %E>%
  filter(migrant_flow > 1) %>%
  arrange(migrant_flow) %>%
  filter(!edge_is_loop()) %>%
  ggraph(x = x, y = y) +
#    geom_sf(data = spatial_patterns, aes(fill = grf_100)) +
  geom_edge_link(aes(color = migrant_flow), width = 1.2) +
  scale_size_area() +
  scale_edge_color_viridis() +
  geom_node_point(aes(size = population))+
  #coord_sf(datum = NA) +
  scale_fill_scico(palette = 'bamako') +
  coord_equal() +
  theme_void()
```

```{r}
last(sim4) %>%
  nystuen_dacey() %>%
  mutate(group = group_components()) %>%
  as_tibble %>%
  bind_cols(spatial_patterns,.) %>%
  select(x, y, food, population, EOF, group) %>%
  `st_precision<-`(10) %>%
  group_by(group) %>%
  summarise(food = sum(food), population = sum(population), geometry = st_union(geometry)) %>%
  ggplot() +
  geom_sf(aes(fill = population)) +
  scale_fill_scico(palette = 'bamako')
```


It matters less if you're on productive land, more if you have access to productive land no one else does


# Discussion

This study found that the costs of transporting food into settlements are more imporant than the costs for migrants moving between settlements in shaping overall settlement patterns. These results show that precise nature of social interaction, trade or migration, has important consequences for understanding patterns of spatial interaction.

This study focused on a regular lattice of settlements occupying a uniform environemnt in order to isolate the effects of the spatial interaction dynamics on the behavior of the system. But the dynamics of spatil interaction are hihgly nonlinear, which means that the initial conditions and boundary conditions of a system will constrain its ultimate trajectory. In any given real-world setting, the initial distirubtion of sites, not to mentio the spatil configuration of productive land and physical impediments to travel, will influence the spatial patterns of settlement that result. Future exploration of this model will incorporate such enviornmental variability, and seed to classify general classes of variability -0- such as differences in spatial or temporal autocorrelation -- that lead to qualitatively differnet settlement pattern outcomes.

Future work should also draw on the extensive toolkit for dynamic spatial ineraction models developed in geography and economics. These involve various ways of further disaggregated key flows in the system, and of incorporating more complex or context-specific settlement dynamics. For example, one could explore flows of different resources, nor just food but also raw materials for energy or craft production that also contribute to a settlement's carrying capcacity. Similarily, one could explore different types of migration behavior among different age, ethnic, or social classes. Given more precise models of the spatial flows, the dynamics of settlement growth and decline can also be elaborated. In this version, the production of food and migrants, before they are spatially allocated, are assumed to be constant or a fixed proportion of population. We might instead model the dynamics of the food produceser directly, incorporating feedbavks between producer and consumer ppulations [@Turch2011]. or we could allow migration rates to vary, based on population size [@that plos article] or differences between the per capita food supply of each settlement and its neighbors [@anderies]. Even if these elaborations do little to alter the ultimate settlement structures at equilibrium, they may introduce important new behaviors as theses systems approach equilbiria -- so called "transient" dynamics that vary in concert more complicated initial and boundary conditions, and will go a long way towards reproducing the empricial archaeological record.

And it is precisely here, at the interface of archaeological theory and data, where spatial interaction models can most contribute. These models support both dynamical and statisitcal implementation -- the same model can be used as a tool for developing theory on the one hand and interpereting data on the other -- as true qwuantitaitve theory ought. Numerical simulation with these models can help eximulate the empirical archaeological record, and act as a test bed for the development of new statistical methods. For example, a typical interaction model can esitmate only one $\beta$ coefficient, which may be the coefficient of distance in a log-linear regression model. How should we interpet this single estimated parameter when it is possible, and likely, that multiple processes exhibiting exponential distance decay are interacting to produce the data at hand? Dissaggregated, dynamic spatial inteactio models will allow us to flexibly explore different dynamical proceese interacting to formthe stable patterns we see in the field.

Settlement pattern data are one of the most basic components of the archaeological record, yet only in recent decades have archaeologists developed the computational expertise and theoretical tools needed to reconstruct the social fabrics binding those settlements together. But the utility of such datasets for addressing questions of societal relevence. As the present-day refugee crisis in southwest Asia demonstrates so clearly, climate change, food security, and migration are tightly interwoven components of the same complex system. Yet archaeological settlement pattern data are rarely comprehensible to the researchers, policy advisors, and stakeholders in the developing world most likely to gain meaningful insight from the information they contain. The solution to this problem lies in the fuller integration of theory and data from the the social sciences as a whole.

the strength
what it is useful for
the difference made



the gap -- interaction between food production, transport, and migration in a spatially rich context

Results > conclusion
the transportation cost for moving food to people define resource territory size and carrynig capacity for settlements, migration costs serve to even out variabillity. The relative attractiviness of populatio vs welfare is imporatnt for understand heirharchy formation. 


limits in filling gap
production of food and migrants could be more dynamic


limits in generalization
uniform environment, uniform accessibility. real world has bottlenecks structural constrians and different relative attractivness. These initial conditions could shape the evolutino of the setltement network.


contributions beyond
generative framework for thinking about statistical inference on archaeological networks, and rooting it in anthropological reality. so in the real world you usually only get one beta estimate for exp distance, but must be cautios in interpreting this physically because that may combine betas from multiple trip transports


science is better now
spatial complexity for ecological models, dissaggregation and dynamics for spatial interaction models

constant migration rate

migration often acts as a stabilizing mechanisms
discuss in light of anderies and hegmon 2011 specificaly

the importance of terriotiality and comeption for access to agricultural land



Edge effects -- different ways of handling them. Sidestepped here by the shear size of the domain. hexagons have low perimeter to area ratio

different functional forms for distance decay

Next, allow climate variability to influence resource dynamics. Assume a water-limited environment, so that the growth rate and carrying capacity of the resource represents the limitation of soil moisture on resource growth and abundance. The static parameters $r$ and $K$ are replaced with an unknown function $f\left(X_i, Q_i\right)$, representing logistic growth dependant on soil moisture $Q$ -- such functions are common in ecology \parencite[e.g., see][]{Ursino2007ModelingProcesses} but are kept generic here to enable application in variable ecohydrological contexts. As with $\mathbf{H}$ and $\mathbf{E}$ above, $Q$ can be replaced by an $I \times I$ adjacency matrix $\mathbf{Q}$, representing the pairwise directed moisture fluxes between all $X_i$ resource systems. This moisture-recycling network can be generated synthetically by the modeler, to explore different environmental scenarios, or estimated empirically from gridded observations, climate model outputs, or paleo-reanalysis data.

Empirical estimates of $\mathbf{Q}$ can be derived using functional network analysis, a method for inferring latent connectivity by comparing time series measured at every element of a complex system [@Donges2015UnifiedPackage]. The elements of an empirical $\mathbf{Q}$ correspond to the \textit{transfer entropy} between time series of precipitation minus evapotranspiration (i.e. the land-atmosphere moisture flux) at each grid cell of a climate model. Transfer entropy is an information-theoretic measure analogous to standard measures of correlation, but extended to capture causal dependencies between nonlinear time series [@Runge2012EscapingEntropy]. As such, a functional network representation of climate variability is conceptually and mathematically similar to the empirical orthogonal functions used in the American Southwest case but allows for more direct representations of the circulation dynamics leading to those patterns [@Donges2015]. 

Why hexagons (birch et al 2007). Edge effects of the whole hexagonal domainare slo decreased

# Conclusion


# References {#references .unnumbered}

```{r}
knitr::knit_exit()
```


```{r}
anim <- sim4 %>%
#   map(nystuen_dacey) %>%
   map(as_tibble, 'nodes') %>%
  bind_rows(.id = 'time') %>%
  mutate(time = as.numeric(time)) %>%
  filter(between(time, 1, 500)) %>%
 #filter(time %% 5 == 0) %>%
ggplot() +
  #  geom_sf(data = spatial_patterns, aes(fill = grf_100)) +
  geom_point(aes(x, y, size = population))+#aes(color = terminal)) +
  #coord_sf(datum = NA) +
  coord_equal() +
  #scale_fill_scico(palette = 'bamako')
  theme_void() +
  labs(title = 'Year: {closest_state}') +
  transition_states(time)

animate(anim, nframes = 999)
```
